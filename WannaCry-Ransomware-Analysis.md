# Malware Analysis and Triage - Wanacry
*disclamer: This report is of my opinion and understanding ONLY. This is for educational purposes ONLY. My opinions on this may change as I learn more.*
![](https://i.imgur.com/vktzISv.png)



## Executive Summary
MD5 Hash: 
```db349b97c37d22f5ea1d1841e3c89eb4```
SHA1 Hash: 
```e889544aff85ffaf8b0d0da705105dee7c97fe26```
SHA256 Hash: 
```24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c```

Wanacry is a ransomware worm that encrypts your files, holding them ransom till you send $300 in bitcoin. It also spreads itself using SMB and the EternalBlue exploit. Effectively making your computer unusable until the ransom is paid or you revert your system to a pre-infected backup.

## High-Level Technical Analysis
The malware consists of 3 parts, the Encryption program the decryption program and a service based persistence mechanism. The malware unpacks all these in a directory it attempts to hide in C:\Program\Data\(RANDOM STRING)
## Malware Composition and Components
#### C:\ProgramData\RandomString123
- staging directory with a random name like dveqybqwqzws072
- the binary runs icacls on this dir and attempts to -h to hide it
#### taskche.exe is created and ran with the -i flag
- This does most of the heavy lifting 
- unzips the main folder
- moves and renames it
- gives it new permissions and the "hidden" attribute
- It also sets up a listener on port 9050 the TOR port

#### Service installation
- The service name will have something to do with Microsoft Security Center 2.0
- This is a persistence mechanism so if the computer is restarted wana cry will restart and continue encrypting any new or unencrypted files
![](https://i.imgur.com/tu9HsAI.png)
#### How it all comes together
![](https://i.imgur.com/y75Jejk.png)




## Basic Static Analysis
#### PEView
![](https://i.imgur.com/WjRU5vR.png)

Interesting Import Address Table API calls:
CreateServiceA
StartServiceA
CryptGenRandom
CryptAcquireContextA
CreateFileA
InternetOpenA
InternetOpenUrlA
#### Floss.exe
![](https://i.imgur.com/eTcJdUr.png)

Interesting Strings in the floss.exe output:
```
floss.exe Wanacry.exe > wanacry.floss.output
```
We get a clue about what language this malware was written in and what looks like hard coded internal IPs. Possible to start trying to spread.
```
SNIP...
Microsoft Visual C++ Runtime Library
<program name unknown>
Runtime Error!
Program: 
         (((((                  H
         h((((                  H
                                 H
USER32.DLL
CONOUT$
Windows 2000 2195
Windows 2000 5.0
\\172.16.99.5\IPC$
Windows 2000 2195
Windows 2000 5.0
\\192.168.56.20\IPC$
kernel32.dll
WanaCrypt0r
Software\
.der
.pfx
.key
.crt
.csr
```
Below a possible unpacked PE named lhdfrgui.exe and its description as Disk Defragmenter. 
```
SNIP...
Microsoft Corporation
FileDescription
Microsoft
 Disk Defragmenter
FileVersion
6.1.7601.17514 (win7sp1_rtm.101119-1850)
InternalName
lhdfrgui.exe
LegalCopyright
 Microsoft Corporation. All rights reserved.
OriginalFilename
lhdfrgui.exe
ProductName
Microsoft
 Windows
 Operating System
ProductVersion
6.1.7601.17514
VarFileInfo
Translation

```
Below, we can see the call to Microsoft Enhanced RSA and AES provider. 
- We also see a taskche.exe PE hard-coded and started.
- icacls command and an "attrib +h ." to give an entire directory a "hidden" property. 
- Some hard-coded hashes are present. (115p7UMMngoj1pMvkpHijcRdfJNXj6LrLn)
- The WNcry@2ol7 looks like a bad password.
```
Microsoft Enhanced RSA and AES Cryptographic Provider
CryptGenKey
CryptDecrypt
CryptEncrypt
CryptDestroyKey
CryptImportKey
CryptAcquireContextA
cmd.exe /c "%s"
115p7UMMngoj1pMvkpHijcRdfJNXj6LrLn
12t9YDPgwueZ9NyMgw519p7AA8isjr6SMw
13AM4VW2dhxYgXeQepoHkHSQuy6NgaEb94
%s%d
Global\MsWinZonesCacheCounterMutexA
tasksche.exe
TaskStart
t.wnry
icacls . /grant Everyone:F /T /C /Q
attrib +h .
WNcry@2ol7
GetNativeSystemInfo
```
We have a path description with %s so the malware is checking dynamically for a place to unpack a folder(possibly) called qeriuwjhrf
- We also see a long URI 
- A service start and a service named mssecsvc2.0 and/or Microsoft Security Center (2.0) Service
```
\\%s\IPC$
Microsoft Base Cryptographic Provider v1.0
%d.%d.%d.%d
mssecsvc2.0
Microsoft Security Center (2.0) Service
%s -m security
C:\%s\qeriuwjhrf
C:\%s\%s
WINDOWS
tasksche.exe
CloseHandle
WriteFile
CreateFileA
CreateProcessA
http://www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com
```

## Basic Dynamic Analysis
#### Detonation and initial IOCs
![](https://i.imgur.com/bKgadqe.png)

We found one of our hard-coded hashes here in the bitcoin address
![](https://i.imgur.com/1AHlgtd.png)

We have our desktop background changed and @!WanaDecryptorAT.exe popping up on our desktop
![](https://i.imgur.com/Cf8ZUFh.png)
#### ProcMon
In ProcMon we can see it modifying registry and loading 32 bit dlls
![](https://i.imgur.com/0MxPx3J.png)
as well as creating the taskche.exe we saw in the binary executing with the /i flag
![](https://i.imgur.com/vxcJhk3.png)
![](https://i.imgur.com/MEENgqy.png)

The service we saw in the strings output is also present and running
![](https://i.imgur.com/OuX5ZlO.png)

The staging area is revealed as well
![](https://i.imgur.com/qr9kcPI.png)

#### Contents of some files in the staging area:
f.wnry
![](https://i.imgur.com/cCCf6LY.png)

r.wnry
![](https://i.imgur.com/w16FvND.png)

s.wnry (binary with some references to tor)
![](https://i.imgur.com/305HNa7.png)

t.wnry (WANACRY!)
![](https://i.imgur.com/fibUwHs.png)

Some more references to TOR
![](https://i.imgur.com/6RpBmWR.png)

## 	Advanced Static Analysis
#### Cutter
![](https://i.imgur.com/Xpsb0iY.png)

In cutter, we are able to disassemble the binary and look at how it's interacting with the CPU registers. 

### Main()
Looking at main we find our long URL and this check to jump to a function

![](https://i.imgur.com/d4MQRBJ.png)
![](https://i.imgur.com/kWCjQUt.png)

InternetOpenUrlA returns a boolean value if a website is up or down, seems odd to exit if the weird URL is up!
Since it either follows the next function or just exits, we will follow the function
![](https://i.imgur.com/BrOrMuy.png)

A quick look will show that it is checking for the service it needs for persistence and then unpacks the rest of the binary and starts the encryption routine.
![](https://i.imgur.com/2aDorMr.png)



## Advanced Dynamic Analysis
#### Kill switch function
The main binary attempts to call out to a URL 
![](https://i.imgur.com/wYXvTrx.png)

If the binary gets a 200 OK from the web server it will exit its control flow and NOT encrypt the files. we can test this with INETSIM running on our fake REmnux Router

![](https://i.imgur.com/7dJI8Sp.png)

Lets take a closer look at this execution flow in a debugger
#### x32dbg
We can search for our long URL and set a break point 
![](https://i.imgur.com/dcK05ri.png)

Stepping forward till we hit our breakpoint, we can see the API calls we saw in cutter and see the URL being moved into ESI

![](https://i.imgur.com/PA5zuMI.png)

We can try and see if we can modify the value of a register in order to get wanacry to go off, EVEN if we can connect to the peculiar URL.
![](https://i.imgur.com/V4fREGc.png)

At this point it has checked for a connection to the odd URL, gotten a SUCCESS, is testing EDI against itself and the JNE zero flag is set to 1
if we double-click and change that zero flag to 0 we should get the program to NOT exit and continue the execution of the next function.

![](https://i.imgur.com/Rv34dKf.png)


## Host Based Indicators
#### C:\ProgramData\akarqvcknlwnsj476(randomly generated)\tasksche.exe
MD5:
```84C82835A5D21BBCF75A61706D8AB549```
Sha1:
```5FF465AFAABCBF0150D1A3AB2C2E74F3A4426467```
SHA256:
```ED01EBFBC9EB5BBEA545AF4D01BF5F1071661840480439C6E5BABE8E080E41AA```
#### C:\users\public\desktop\\@wanadecryptorAT.exe
md5: 
```7BF2B57F2A205768755C07F238FB32CC```
sha1: 
```45356A9DD616ED7161A3B9192E2F318D0AB5AD10```
sha256: 
```B9C5D4339809E0AD9A00D4D3DD26FDF44A32819A54ABF846BB9B560D81391C25```

## Network Based Indicators
#### Hard-coded URL
![](https://i.imgur.com/o8iJiU9.png)
Making any call to this URL should be a clear indicator and should be ALLOWED since it will stop the ransomware from firing.
#### TCPView 
We can see that while wanacry is encrypting our files it's also reaching out over port 445 (samba/SMB) to try and connect and spread itself. Interesting that the module name is the service that it installs and sets to auto run. Always looking for the next victim.
![](https://i.imgur.com/upgAPDs.png)

## Conclusion

This malware is pretty straight forward and simple. This is probably its greatest strength and the reason why it is so infamous. The basic strategy to spread and lockdown as well as its modest ransom amount probably lead to a lot of payments and a lot of infections. As of my research, the original wanacry attack made 54.4 BTC. If you looked at that in today's value would be 2.6 million but was around 150k in 2017.

## Basic Yara rule

```python
rule Yara_WanaCry_rules {
    
    meta: 
        last_updated = "2021-12-16"
        author = "Relativ3Pa1n"
        description = "A simple Yara rule for Wanacry Ransomware"

    strings:
        // Fill out identifying strings and other criteria
		$BTC_addr1 = "115p7UMMngoj1pMvkpHijcRdfJNXj6LrLn"
		$BTC_addr2 = "12t9YDPgwueZ9NyMgw519p7AA8isjr6SMw"
		$BTC_addr3 = "13AM4VW2dhxYgXeQepoHkHSQuy6NgaEb94"
		$Kill_switch_URL = "http://www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com"
		$wnry = ".wnry"
		$WanaCrypt = "WanaCrypt0r"
		

    condition:
        // Fill out the conditions that must be met to identify the binary
		$BTC_addr1 or $BTC_addr2 or $BTC_addr3 and
		$wnry or $WanaCrypt or $Kill_switch_URL
		
}
```
![](https://i.imgur.com/iCuk1Z3.png)

